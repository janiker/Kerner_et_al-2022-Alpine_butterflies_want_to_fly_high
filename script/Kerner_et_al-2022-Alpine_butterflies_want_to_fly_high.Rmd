---
title: "Alpine butterflies want to fly high: Species and communities shift upwards faster than their host plants"
author: Janika M. Kerner^1^*, Jochen Krauss^1^, Fabienne Maihoff^1^, Lukas Bofinger^2^, Alice Classen^1^
output:
  bookdown::word_document2:
    reference_docx: Word_template_ecology.docx
fontfamily: Times New Roman
fontsize: 12pt
geometry: margin = 1in
---

^1^ Department of Animal Ecology and Tropical Biology, Biocenter, University of Würzburg, Am Hubland, 97074 Würzburg, Germany

^2^ Landesumweltanwaltschaft Salzburg, Membergerstrasse 42, 5020 Salzburg, Austria

\* Corresponding author: [janika.kerner\@uni-wuerzburg.de](mailto:janika.kerner@uni-wuerzburg.de){.email}

\clearpage

\newpage

```{r formatting, echo=FALSE, warning=FALSE}
# table font
library(flextable)
set_flextable_defaults(
  font.family = "Times New Roman")
# plot resolution
knitr::opts_chunk$set(dpi=600)

library(bookdown)
```

```{r div-ele-calc, include=FALSE}
library(broom) # tidy summary tables
library(emmeans) # post-hoc (Tukey-Test) for differences between grouping variables in lm
library(ggplot2)
library(lme4) # LME calculation
library(lmerTest)
library(mgcv)
library(plyr) # revalue
library(png) # load pictures
library(tidyverse) # clean data
library(vegan) # species richness
library(tidymv) # GAMs plotting in ggplot

# GAM models abundance & richness ----------------------------------------------

# read data

# plotdata long format (one year below the other)
pdl<-read.csv(here::here("data", "plotdata-long.csv"), row.names=1, sep=";")
pdl$year<-factor(pdl$year,ordered=T) # has to be ordered for GAM summary to be ANOVA like difference between levels
pdl$plot<-as.factor(pdl$plot)

# plotdata short format (years next to each other)
plotdata<-read.csv(here::here("data", "plotdata.csv"), row.names=1, sep=";")

# plotdata long format excluding T3 because of missing plant data
s66<-read.csv(here::here("data", "plotdata-SEM.csv"), sep=";")
s66$plot<-as.factor(s66$plot)
s66<-s66[s66$plot!="T3",] # exclude T3 (no plant data)
s66$flow_cov<-log(s66$flow_cov) # log transform for normal distribution
s66$year<-factor(s66$year,ordered=T) # has to be ordered for the correct GAM summary


# abundance
aby<-summary(gam(ab~s(elev, k=4)+s(elev,by=year,k=4)+year+s(plot, bs="re"), data=pdl, family=poisson, method="REML"))


# butterfly richness
divy<-summary(gam(spec.no~s(elev, k=4)+s(elev,by=year,k=4)+year+s(plot, bs="re"), data=pdl, family=poisson, method="REML"))

moddivy<-gam(spec.no~s(elev, k=4)+s(elev,by=year,k=4)+year, data=pdl, family=poisson, method="REML")
moddivy<-get_gam_predictions(moddivy, elev, series_length = 1391)
for (i in c("spec.no","SE","CI_upper","CI_lower")){ # backformation poisson (log)
  moddivy[i]<-exp(moddivy[i])
}


# host plant richness
dipy<-summary(gam(div.hp~s(elev, k=4)+s(elev,by=year, k=4)+year+s(plot, bs="re"), data=s66,family=poisson,method="REML"))

moddipy<-gam(div.hp~s(elev, k=4)+s(elev,by=year,k=4)+year, data=s66, family=poisson, method="REML")
moddipy<-get_gam_predictions(moddipy, elev, series_length = 1391)
for (i in c("div.hp","SE","CI_upper","CI_lower")){ # back transformation poisson (log)
  moddipy[i]<-exp(moddipy[i])
}
colnames(moddipy)[4]<-"spec.no"


# check significant differences between spec.no sections (lowland, mid-elevation, highland)
t1<-t.test(spec.no~year,data=droplevels(subset(pdl,pdl$elev<1000)))
t2<-t.test(spec.no~year,data=droplevels(subset(pdl,pdl$elev>=1000 & pdl$elev<1500)))
t3<-t.test(spec.no~year,data=droplevels(subset(pdl,pdl$elev>=1500)))
```

```{r specsat, include=FALSE}
# species richness saturation:

# lower plots sampled six times
w6<-summary(c(subset(plotdata,plotdata$plot %in% c("H1","H2","HO1","HO2","T1","T3","T4","T5","W1","W2","WmA1","WmA2","WmB1","WmB2"))$det.rate09,
          subset(plotdata,plotdata$plot %in% c("H1","H2","HO1","HO2","T1","T3","T4","T5","W1","W2","WmA1","WmA2","WmB1","WmB2"))$det.rate19))

# upper plots sampled five times
w5<-summary(c(subset(plotdata,!(plotdata$plot %in% c("H1","H2","HO1","HO2","T1","T3","T4","T5","W1","W2","WmA1","WmA2","WmB1","WmB2")))$det.rate09,
          subset(plotdata,!(plotdata$plot %in% c("H1","H2","HO1","HO2","T1","T3","T4","T5","W1","W2","WmA1","WmA2","WmB1","WmB2")))$det.rate19))
```

```{r commsc, include=FALSE}
# model community elevation score

C<-summary(gam(comsc~s(elev, k=4)+s(elev,by=year, k=4)+year+s(plot, bs="re"), data=pdl,method="REML"))

modC<-gam(comsc~s(elev, k=4)+s(elev,by=year,k=4)+year, data=pdl, method="REML")
modC<-get_gam_predictions(modC, elev, series_length = 1391)
```

```{r calcbuttshift, include = FALSE}
### mean shift model of all butterfly species (>= 10 individuals per species in each year)

shift<-read.csv(here::here("data", "butterfly-shifts-10individuals.csv"), row.names=1) # load species elevations

x<-summary(lmer(melev ~ year+(1|spec), data=shift))

### linear model, with individuals as data points to check significance for single butterfly species

B<-read.csv(here::here("data", "butterflies-elevation-individual.csv"), sep=";") # load individual elevations all species

j<-lm(elev~year*genus_species, data=B)

ii<-tidy(emmeans(j, pairwise~year|genus_species, weights = "proportional")$contrasts)
ii$estimate<-ii$estimate*-1 # mirror results back

### check for signifikant difference in shifts between alpine and non-alpine butterfly species

alpspec<-c("Araschnia_levana", "Boloria_pales", "Boloria_thore", "Coenonympha_gardetta", "Colias_phicomone", "Erebia_epiphron", "Erebia_eriphyle", "Erebia_euryale", "Erebia_gorge", "Erebia_manto", "Erebia_oeme", "Erebia_pandrose", "Erebia_pharte", "Erebia_pronoe", "Euphydryas_cynthia", "Lasiommata_maera", "Lasiommata_petropolitana", "Pieris_bryoniae", "Pyrgus_andromedae", "Pyrgus_cacaliae") # alpine species

alpi<-merge(shift[shift$year=="2009",c("spec", "melev")],ii[,c("genus_species","estimate")], by.x="spec", by.y="genus_species")

alpi$alpine[alpi$spec %in% alpspec]<-"alpine"
alpi$alpine[!alpi$spec %in% alpspec]<-"non-alpine"

modalpi<-lm(estimate~melev+alpine, data=alpi)

valalpi<-summary(modalpi)
```

```{r calcplantshift,include=FALSE}
### mean shift model of all host plant species (>= 10 occupied subplots per species in each year)

sshift<-read.csv(here::here("data", "hostplant-shifts-10subplots.csv"), row.names=1) # load species elevations

xx<-summary(lmer(melev ~ year+(1|abbr), data=sshift))

### linear model, with individuals as data points to check significance for single host plant species
st<-read.csv(here::here("data", "hostplants-elevation-subplot.csv"), sep=";") # load individual elevations all species

plam<-lm(elev~year*abbr, data=st)

plammy<-tidy(emmeans(plam, pairwise~year|abbr, weights = "proportional")$contrasts)
plammy$estimate<-plammy$estimate*-1
```

```{r shiftselect.butt.calc, include=FALSE}
# calculate mean elevational shift of butterflies according to selected min. no. of individuals and included species number

# mean elevation per species and year with number of individuals and difference in elevation
spwm<-read.csv(here::here("data","butterfly-species-weighted-mean.csv"),row.names = 1)

# mean elevation per species with test results
allbutt.shifts<-read.csv(here::here("data","all-butterfly-species-shifts.csv"),row.names = 1)

a<-as.data.frame(5:30);colnames(a)<-"no.ind"
a$mean<-0; a$no.species<-0
a$n.s.<-0;a$cs<-0;a$s<-0;a$ss<-0;a$sss<-0

for (i in a$no.ind){
  a$mean[a$no.ind==i]<-mean(spwm$diff[spwm$ind09>=i & spwm$ind19>=i])
  a$meansig[a$no.ind==i]<-mean(spwm$diff[spwm$ind09>=i & spwm$ind19>=i & spwm$spec %in% allbutt.shifts$spec[allbutt.shifts$p.value<=0.05]])
  a$no.species[a$no.ind==i]<-nrow(spwm[spwm$ind09>=i & spwm$ind19>=i,])
  a$n.s.[a$no.ind==i]<-nrow(subset(allbutt.shifts[allbutt.shifts$ind09>=i & allbutt.shifts$ind19>=i,],p.value>0.1))
  a$cs[a$no.ind==i]<-nrow(subset(allbutt.shifts[allbutt.shifts$ind09>=i & allbutt.shifts$ind19>=i,],p.value<=0.1 & p.value>0.05))
  a$s[a$no.ind==i]<-nrow(subset(allbutt.shifts[allbutt.shifts$ind09>=i & allbutt.shifts$ind19>=i,],p.value<=0.05 & p.value>0.01))
  a$ss[a$no.ind==i]<-nrow(subset(allbutt.shifts[allbutt.shifts$ind09>=i & allbutt.shifts$ind19>=i,],p.value<=0.01 & p.value>0.001))
  a$sss[a$no.ind==i]<-nrow(subset(allbutt.shifts[allbutt.shifts$ind09>=i & allbutt.shifts$ind19>=i,],p.value<=0.001))
}
```

```{r shiftselect.hp.calc, include=FALSE}
# calculate mean elevational shift of host plants according to selected min. no. individuals and included species number

# mean elevation per species and year with number or individuals and difference in elevation
wsb<-read.csv(here::here("data","hostplant-species-weighted-mean.csv"),row.names = 1)

# mean elevation per species with test results
sub.shifts<-read.csv(here::here("data","all-hostplant-species-shifts.csv"),row.names = 1)

m<-as.data.frame(5:30);colnames(m)<-"no.sb"
m$mean<-0; m$no.species<-0
m$n.s.<-0;m$cs<-0;m$s<-0;m$ss<-0;m$sss<-0

for (i in m$no.sb){
  m$mean[m$no.sb==i]<-mean(wsb$diff[wsb$no.sb09>=i & wsb$no.sb19>=i])
  m$meansig[m$no.sb==i]<-mean(wsb$diff[wsb$no.sb09>=i & wsb$no.sb19>=i & wsb$abbr %in% sub.shifts$abbr[sub.shifts$p.value<=0.05]])
  m$no.species[m$no.sb==i]<-nrow(wsb[wsb$no.sb09>=i & wsb$no.sb19>=i,])
  m$n.s.[m$no.sb==i]<-nrow(subset(sub.shifts[sub.shifts$no.sb09>=i & sub.shifts$no.sb19>=i,],p.value>0.1))
  m$cs[m$no.sb==i]<-nrow(subset(sub.shifts[sub.shifts$no.sb09>=i & sub.shifts$no.sb19>=i,],p.value<=0.1&p.value>0.05))
  m$s[m$no.sb==i]<-nrow(subset(sub.shifts[sub.shifts$no.sb09>=i & sub.shifts$no.sb19>=i,],p.value<=0.05&p.value>0.01))
  m$ss[m$no.sb==i]<-nrow(subset(sub.shifts[sub.shifts$no.sb09>=i & sub.shifts$no.sb19>=i,],p.value<=0.01&p.value>0.001))
  m$sss[m$no.sb==i]<-nrow(subset(sub.shifts[sub.shifts$no.sb09>=i & sub.shifts$no.sb19>=i,],p.value<=0.001))
}
```

```{r calcSEM, include=FALSE}
library(data.table) # create empty data frame
library(MuMIn) # calculate AICc
library(nlme) # lme
library(piecewiseSEM) # SEMs

# SEM for richness drivers ---------------------------------------------------------

#SEMmin1
sem1<-psem(
  lme(flow_cov~man.bin+temps,random=~1|plot,s66,method="ML"),
  lme(div.hp~man.bin+temps,random=~1|plot,s66,method="ML"),
  lme(spec.no~div.hp+flow_cov+man.bin+temps,random=~1|plot,s66)
)

ss1<-summary(sem1, .progressBar = F)

# insert point symbol for marginal significant (> 0.05 <= 0.1)
for (i in 1:8) {
  if (ss1$coefficients$P.Value[i]>0.05 & ss1$coefficients$P.Value[i]<=0.1){
    ss1$coefficients[[9]][i]<-"."}
  }
  
#SEMmin2
sem2<-psem(
  lme(flow_cov~man.bin+temps,random=~1|plot,s66,method="ML"),
  lme(div.hp~man.bin,random=~1|plot,s66,method="ML"),
  lme(spec.no~div.hp+flow_cov+man.bin+temps,random=~1|plot,s66)
)

ss2<-summary(sem2, .progressBar = F)

# SEM for drivers of change in richness (delta values between years) ---------------------

sdel<-read.csv(here::here("data","plotdata-change-between-years.csv"), sep = ";")
sdel$plot<-as.factor(sdel$plot)
sdel<-sdel[sdel$plot!="T3",] # kick out T3 because of missing plant data
sdel$flow_cov<-sqrt(sdel$flow_cov+3) # sqrt transformation for normal distribution, +3 so that all values are positive and can be transformed

# two minimum models for delta

smdel1<-psem(lm(delta~flow_cov+temps,sdel),
             flow_cov~1,
             div.hp~1)
dm1<-summary(smdel1, .progressBar = F)

# insert point symbol for marginal significant (> 0.05 <= 0.1)
for (i in 1:2) {
  if (dm1$coefficients$P.Value[i]>0.05 & dm1$coefficients$P.Value[i]<=0.1){
    dm1$coefficients[[9]][i]<-"."}
  }

smdel2<-psem(lm(delta~temps,sdel),
             flow_cov~1,
             div.hp~1)
dm2<-summary(smdel2, .progressBar = F)
```

```{r temp100, eval=FALSE}
# temperature difference per 100 m based on measured daily means from nearby climate stations
# raw climate station data (LT) not publicly available

LT<-read.csv(here::here("data","daily-mean-temperature-climate-stations.csv"), row.names = 1, sep=";")

library(nlme)
tc100<-summary(lme(daymeanT~Elev_50m, random=~1|Stationsname, data=LT))
tccoef<-tc100[["coefficients"]][["fixed"]][["Elev_50m"]]*-1
```

```{r potshiftcalc, echo=FALSE, warning=FALSE, include=FALSE}
# Temperature calculations ---------------------------------------------------------
# Mean temperature 2009 - 2019

yearmean<-read.csv(here::here("data","yearly-mean-temperature.csv"), row.names = 1) # mean of daily temperature of all plots per year
summean<-read.csv(here::here("data","summer-mean-temperature.csv"),row.names = 1) # mean of daily temperature of all plots per year, only including the summer months (May-Sept)

# complete year
tmean<-summary(lm(daymeanT~year,yearmean))

# summer months
stmean<-summary(lm(daymeanT~year,data=summean))

# Direct difference 2009 & 2019

# complete year
ydiff<-yearmean$daymeanT[yearmean$year==2019]-yearmean$daymeanT[yearmean$year==2009]

# summer months
sdiff<-summean$daymeanT[summean$year==2019]-summean$daymeanT[summean$year==2009]
```

```{r ptemp.calc, include=FALSE, echo=FALSE}
# GAM yearly mean & mean of summer months direct difference 2009 / 2019

gst<-summary(gam(temps~s(elev, k=4), data=sdel, method="REML"))
gyt<-summary(gam(tempy~s(elev, k=4), data=sdel, method="REML"))

# GAM yearly mean & mean of summer months 2009 - 2019

pgst<-summary(gam(ptemps~s(elev, k=4), data=sdel, method="REML"))
pgyt<-summary(gam(ptempy~s(elev, k=4), data=sdel, method="REML"))
```

```{r pval}
# functions to transform p values into significance intervals

pval<-function(p){ # >0.1 als "n.s."
if(p<=0.001) {
  p <- "&le; 0.001"
  } else if (p<=0.01) {
    p <- "&le; 0.01"
    } else if (p<=0.05) {
      p <- "&le; 0.05"
      } else if (p<=0.1) {
        p <- "&le; 0.1"
        } else {p <- "n.s."}
  p
}

pval2<-function(p){ # >0.1 as ">0.1" instead of "n.s."
if(p<=0.001) {
  p <- "&le; 0.001"
  } else if (p<=0.01) {
    p <- "&le; 0.01"
    } else if (p<=0.05) {
      p <- "&le; 0.05"
      } else if (p<=0.1) {
        p <- "&le; 0.1"
        } else {p <- "> 0.1"}
  p
}


# function to transform p values into signs for significance intervals
psign<-function(p){
if(p<=0.001) {
  p <- "***"
  } else if (p<=0.01) {
    p <- "**"
    } else if (p<=0.05) {
      p <- "*"
      } else if (p<=0.1) {
        p <- "."
        } else {p <- "n.s."}
  p
}
```

\clearpage

\newpage

**Table 1:**

```{r gamtables, echo=FALSE, message=FALSE, tab.cap="Summary statistics of generalized additive models (GAMs) for absolute (2009/2019) and gradual (2009-2019) changes in mean annual temperature (MAT) and mean summer temperature (MST), fitted with a smoothing function of elevation (N=32) (see Figure 1b); as well as generalized additive mixed models (GAMMs) for butterfly abundance, butterfly and host plant species richness and the community elevation score, each fitted with a smoothing function of elevation and the interaction of elevation and year (2009, 2019), including study site as a random term (N=64).", label="gamtables"}
options(scipen = 999) # write numbers decimal and not exponential (e+06)

GAMT<-data.frame(resp.var = c("∆ MAT 2009 / 2019",
                              "∆ MST 2009 / 2019",
                              "∆ MAT 2009 - 2019",
                              "∆ MST 2009 - 2019",
                              "butterfly abundance", NA, NA,
                              "butterfly species no.", NA, NA,
                              "host plant species no.", NA, NA,
                              "butterfly community score", NA, NA),
                 smooth = c(rep(c("elevation"),4), rep(c("elevation","elevation : year","study site (random term)"),4)),
                 edf = c(round(gyt$edf, 3),
                         round(gst$edf, 3),
                         round(pgyt$edf, 3),
                         round(pgst$edf, 3),
                         round(aby$edf[1], 3), round(aby$edf[2], 3),
                         round(aby$edf[3], 3),
                         round(divy$edf[1], 3), round(divy$edf[2], 3),
                         round(divy$edf[3], 3),
                         round(dipy$edf[1], 3), round(dipy$edf[2], 3),
                         round(dipy$edf[3], 3),
                         round(C$edf[1], 3), round(C$edf[2], 3),
                         round(C$edf[3], 3)), 
                 Ref.df = c(round(gyt$s.table[1], 3),
                            round(gst$s.table[1], 3),
                            round(pgyt$s.table[1], 3),
                            round(pgst$s.table[1], 3),
                            round(aby$s.table[1,2], 3),
                            round(aby$s.table[2,2], 3),
                            round(aby$s.table[3,2], 3),
                            round(divy$s.table[1,2], 3),
                            round(divy$s.table[2,2], 3),
                            round(divy$s.table[3,2], 3),
                            round(dipy$s.table[1,2], 3),
                            round(dipy$s.table[2,2], 3),
                            round(dipy$s.table[3,2], 3),
                            round(C$s.table[1,2], 3),
                            round(C$s.table[2,2], 3),
                            round(C$s.table[3,2], 3)),
                 p.value = c(paste(ifelse(round(gyt$s.pv,3)==0,"< 0.001",
                                          round(gyt$s.pv,3)),psign(gyt$s.pv)),
                             paste(ifelse(round(gst$s.pv,3)==0,"< 0.001",
                                          round(gst$s.pv,3)),psign(gst$s.pv)),
                             paste(ifelse(round(pgyt$s.pv,3)==0,"< 0.001",
                                          round(pgyt$s.pv,3)),psign(pgyt$s.pv)),
                             paste(ifelse(round(pgst$s.pv,3)==0,"< 0.001",
                                          round(pgst$s.pv,3)),psign(pgst$s.pv)),
                             paste(ifelse(round(aby$s.pv[1],3)==0,"< 0.001",
                                          round(aby$s.pv[1],3)),psign(aby$s.pv[1])),
                             paste(ifelse(round(aby$s.pv[2],3)==0,"< 0.001",
                                          round(aby$s.pv[2],3)),psign(aby$s.pv[2])),
                             paste(ifelse(round(aby$s.pv[3],3)==0,"< 0.001",
                                          round(aby$s.pv[3],3)),psign(aby$s.pv[3])),
                             paste(ifelse(round(divy$s.pv[1],3)==0,"< 0.001",
                                          round(divy$s.pv[1],3)),psign(divy$s.pv[1])),
                             paste(ifelse(round(divy$s.pv[2],3)==0,"< 0.001",
                                          round(divy$s.pv[2],3)),psign(divy$s.pv[2])),
                             paste(ifelse(round(divy$s.pv[3],3)==0,"< 0.001",
                                          round(divy$s.pv[3],3)),psign(divy$s.pv[3])),
                             paste(ifelse(round(dipy$s.pv[1],3)==0,"< 0.001",
                                          round(dipy$s.pv[1],3)),psign(dipy$s.pv[1])),
                             paste(ifelse(round(dipy$s.pv[2],3)==0,"< 0.001",
                                          round(dipy$s.pv[2],3)),psign(dipy$s.pv[2])),
                             paste(ifelse(round(dipy$s.pv[3],3)==0,"< 0.001",
                                          round(dipy$s.pv[3],3)),psign(dipy$s.pv[3])),
                             paste(ifelse(round(C$s.pv[1],3)==0,"< 0.001",
                                          round(C$s.pv[1],3)),psign(C$s.pv[1])),
                             paste(ifelse(round(C$s.pv[2],3)==0,"< 0.001",
                                          round(C$s.pv[2],3)),psign(C$s.pv[2])),
                             paste(ifelse(round(C$s.pv[3],3)==0,"< 0.001",
                                          round(C$s.pv[3],3)),psign(C$s.pv[3]))),
                 family = c(gyt$family$family,
                            gst$family$family,
                            pgyt$family$family,
                            pgst$family$family,
                            aby$family$family, NA, NA,
                            divy$family$family, NA, NA,
                            dipy$family$family, NA, NA,
                            C$family$family, NA, NA),
                 link.function = c(gyt$family$link,
                                   gst$family$link,
                                   pgyt$family$link,
                                   pgst$family$link,
                                   aby$family$link, NA, NA,
                                   divy$family$link, NA, NA,
                                   dipy$family$link, NA, NA,
                                   C$family$link, NA, NA),
                 adj.r2 = c(round(gyt$r.sq, 3),
                            round(gst$r.sq, 3),
                            round(pgyt$r.sq, 3),
                            round(pgst$r.sq, 3),
                            round(aby$r.sq, 3), NA, NA,
                            round(divy$r.sq, 3), NA, NA,
                            round(dipy$r.sq, 3), NA, NA,
                            round(C$r.sq, 3), NA, NA),
                 dev.expl = c(paste(round(gyt$dev.expl*100, 1), "%"),
                              paste(round(gst$dev.expl*100, 1), "%"),
                              paste(round(pgyt$dev.expl*100, 1), "%"),
                              paste(round(pgst$dev.expl*100, 1), "%"),
                              paste(round(aby$dev.expl*100, 1), "%"), NA, NA,
                              paste(round(divy$dev.expl*100, 1), "%"), NA, NA,
                              paste(round(dipy$dev.expl*100, 1), "%"), NA, NA,
                              paste(round(C$dev.expl*100, 1), "%"), NA, NA)
                 )


library(dplyr)

# which columns should be shown in table  
flextable(GAMT, col_keys = c("resp.var", "smooth", "edf", "Ref.df", "p.value", "family", "link.function", "adj.r2", "dev.expl")) %>%
 
# Column labelling  
  set_header_labels(resp.var = "response variable", p.value = "p-value", family = "family", smooth = "predictor", link.function = "link function", adj.r2 = "adjusted R²", dev.expl = "deviance explained") %>%

# Add footer  
add_footer_lines("Signif. codes: 0 <= '***' < 0.001 < '**' < 0.01 < '*' < 0.05 < '.' < 0.1 < 'n.s.' < 1")
```

\clearpage

\newpage

# Figure legends {.unnumbered}

**Figure 1:** (a) Location of the study area in the southeasternmost corner of Germany in the National Park Berchtesgaden (NP BGD, green) and its surroundings. (b) Temperature differences in °C between 2009 and 2019 along the elevational gradient in the National Park Berchtesgaden. There was a considerable difference between mean summer temperature (MST) (purple) and mean annual temperature (MAT) (blue) increase. The darker shades show the absolute difference between the two sampling years (2009/2019) and the lighter ones show the gradual temperature change over the considered decade (2009 - 2019). Temperatures were predicted with generalized additive models (GAMs) from adjacent climate stations for each study site. (c) Climate stations used for temperature modelling were spread throughout the national park and its surroundings (orange). Study sites (light blue) were arranged along five transects (dark blue) plus four valley plots in lower elevations. Grey shades indicate elevation in 200 m intervals, ranging from 400 (black) up to 2800 m a.s.l. (white) (based on a digital elevation model with 1 m grid cell width, provided by the national park administration).

**Figure 2:** Species richness of butterflies (a) and host plants (b) along the elevational gradient in 2009 (blue) and 2019 (orange) with 95% confidence intervals.

**Figure 3:** Drivers of butterfly richness along spatial and temporal gradients in the National Park Berchtesgaden. A priori hypothesized causal structure of the relationships among MST, management, larval (host plant diversity) and adult (flower cover) food resources and species richness of butterflies (a) and the best fitted path model (based on the Akaike information criterion with a correction for small sample sizes, AICc, N = 64) (b). The only alternative model (Δ AICc ≤ 1.5) had one path removed (dashed line), indicating an unstable path. A similar causal structure was hypothesized for a path model which included the absolute differences in explaining variables between 2009 & 2019 (e.g. Δ MST = MST(2019) - MST(2009) (c), whereby change in management was excluded as there were no changes between years. Again, the best fitted path model is presented (N = 32) (d). However, note that although explanatory value was lower, the presented model was statistically not distinguishable (Δ AICc ≤ 1.5) from two other models replacing change in temperature with either overall temperature trend (mean 2009-2019) or management. The standardized path coefficients, their statistical significance (P ≤ 0.1 (.), P ≤ 0.05 (`*`), P ≤ 0.01 (`**`), P ≤ 0.001 (`***`)) and the conditional coefficients of determination (R²) are given. Paths with a significance of p ≤ 0.05 are presented in black and higher values in grey. Flower cover was log-transformed in the first model (b) and sqrt-transformed in the second one (d), prior to analysis.

**Figure 4:** Community elevation score of butterflies along the elevational gradient in 2009 (blue) and 2019 (orange) with 95% confidence intervals. A lower score in 2019 indicates that the community at a certain elevation is now hosting a higher share of species that were found in lower elevations in 2009.

**Figure 5:** Abundance-weighted mean elevational shifts of butterfly (left) and host plant species (right) between 2009 and 2019 (vertical lines) with standard error (horizontal lines). The numbers in brackets give the number of individuals per species sampled in 2009/2019. Alpine butterfly species (lower elevational limit ≥ 500 m a.s.l. according to @paolucci2013) are shown in light and dark blue. Dark blue & black indicate significant shifts with respective significance levels shown next to the species names (left in each panel): \* = p ≤ 0.05, \*\* = p ≤ 0.01, \*\*\* = p ≤ 0.001 (Wilcoxon rank-sum tests).

\clearpage

\newpage

**Figure 1:**

```{r tempchange, eval=FALSE, include=FALSE}
# plotting of temperature graph (Figure 1b), export as svg to combine it externally with map

library(svglite) # to export as svg

ggsave(here::here("figures","tempchange.svg"), plot =(

  sdel %>%
  pivot_longer(cols=c(temps,ptemps,tempy,ptempy),names_to = c("time"),values_to="temp") %>% 
ggplot(aes(x=elev, y=temp, col=time)) +
  geom_hline(yintercept = 0,col="ivory3")+ # zero line
  geom_point(size=3,alpha=.4,shape=16)+
  geom_smooth(method = gam, formula = y ~ s(x, k=4), size = 2, se = F, alpha=.2) +
  theme_classic()+ # white background
  theme(# panel.background = element_rect(colour = "black", size=0.5), # black frame
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    legend.position = c(0.75,0.2),
    legend.title=element_text(size=14,margin = margin(l = -6)),
    legend.text = element_text(size=14),
    legend.key.height = unit(0.2, "cm"),
    legend.background = element_blank(),
    axis.text = element_text(size=20),
    axis.title.x = element_text(size=20,margin = margin(t = 10, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(size=20,margin = margin(t = 0, r = 10, b = 0, l = 0)))+
  labs(x="elevation [m.a.s.l.]",y=expression(paste(Delta, " temperature [°C]")))+
  scale_x_continuous(breaks=c(750,1000,1250,1500,1750,2000))+
  scale_y_continuous(n.breaks=4)+
  scale_color_manual(name="MST  MAT", values = c("temps"="violetred4", "ptemps"="#CC8FAB", "tempy"="navyblue", "ptempy"="#7D7DB3"),labels=c(" "," ","year difference\n(2009/2019)","long term trend\n(2009-2019)"),
  guide=guide_legend(ncol=2))+
  annotation_custom(
    grid::rasterGrob(
      image = readPNG(here::here("figures","Logo_temperature.png")),
      x = .05, y =.9,
      width =.15))
), dpi=300, width=6, height=5)
```

```{r plotlocation-temp, fig.cap="", echo=FALSE, dpi=300}
library(knitr)
include_graphics(here::here("figures","location_study_sites_and_climate_stations.png"))
```

\clearpage

\newpage

**Figure 2:**

```{r div-ele, fig.cap="", fig.width=5, fig.height=7, echo=FALSE}

library(tidyverse);library(forcats);library(ggplot2);library(mgcv);library(png);library(grid)

# Facet labels (a, b)
tags<-data.frame(x=c(rep(700,4)), y=c(rep(30,4)),lab=c(rep(c("a)","b)"),2)),
                 group=c("spec.no","div.hp"))

gg<-bind_rows("spec.no"=moddivy,"div.hp"=moddipy, .id = "group") %>% # combine to put spec.no & div.hp underneath each other
ggplot(aes(x=elev, y=spec.no, colour=as.factor(year), fill=as.factor(year))) +
  facet_wrap(vars(fct_inorder(group)),ncol = 1, scales = "free") +
  geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper), alpha = 0.2, colour = NA) + # colour=NA to remove outer margins
  geom_line(size=2)+
  geom_point(data=s66 %>%
    pivot_longer(cols=c(spec.no,div.hp),names_to = c("group"),values_to="spec.no"),aes(x=elev, y=spec.no),size=3,alpha=.4,shape=16) +
  theme_classic()+ # white background
  theme(# panel.background = element_rect(colour = "black", size=0.5), # black frame
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    panel.spacing = unit(1, "cm"),
    legend.position = c(0.7,0.97),
    legend.title=element_blank(), # remove legend title
    legend.text = element_text(size=14),
    axis.text = element_text(size=14),
    axis.title.x = element_text(size=14,margin = margin(t = 10, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(size=14,margin = margin(t = 0, r = 10, b = 0, l = 0)),
    strip.text = element_blank())+ # remove Label bar above plots from facetwrap
  labs(x="elevation [m.a.s.l.]",y="species richness")+
  scale_x_continuous(breaks=c(750,1000,1250,1500,1750,2000))+
  scale_y_continuous(n.breaks=8)+
  scale_fill_manual(name="year", values = c("2009"="dodgerblue", "2019"="orange"))+
  scale_color_manual(name="year", values = c("2009"="dodgerblue", "2019"="orange"))+
  annotate(geom = 'segment', y = -Inf, yend = -Inf, color = 'black', x = -Inf, xend = Inf, size = 0.5) +
  geom_text(inherit.aes = FALSE, data=tags, aes(x= -Inf, y=Inf, label=lab),hjust=-1,vjust=1, size=5) # insert facet labels

# Add logos

g <- ggplot_gtable(ggplot_build(gg))

facets <- grep("panel", g$layout$name)
logos <- list(rasterGrob(readPNG(here::here("figures","Logo_Erebia_euryale.png")),
                             width=.15, x = .9, y = .92),
                  rasterGrob(readPNG(here::here("figures","Logo_host_plant.png")),
                             width=.15, x = .9, y = .93))
g2 <- with(g$layout[facets,],
          gtable::gtable_add_grob(g, logos,
                          t=t, l=l, b=b, r=r))
plot(g2)
```

\clearpage

\newpage

**Figure 3:**

```{r sem, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, include=FALSE}

library(qgraph) # plot SEMs nicely
library(png)
library(grid) # arrange png-files
library(gridExtra)

# manual matrix with estimates from psem

t=matrix(c(rep(0,5*5)),5,5,byrow=T)
colnames(t)<-c("flower cover","host plant spec. no.","butterfly spec. no.","summer temperature","management")
rownames(t)<-colnames(t)
t[5,1]=ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="flow_cov"]
t[4,1]=ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="flow_cov"]
t[5,2]=ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="div.hp"]
t[4,2]=ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="div.hp"]
t[2,3]=ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="div.hp" & ss1$coefficients$Response=="spec.no"]
t[1,3]=ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="flow_cov" & ss1$coefficients$Response=="spec.no"]
t[5,3]=ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="spec.no"]
t[4,3]=ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="spec.no"]


# matrix positioning labels/variables from table t, where they should appear in path model graphic
l1=matrix(c(rep(0,35)),5,7)

l1[3,4]=4
l1[5,4]=5
l1[4,3]=1
l1[4,4]=3
l1[4,5]=2

signlabels<-c( # significance values from summary for single arrows in model, order according to number of response var
  paste(round(ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="flow_cov"],digits=2),ss1$coefficients[[9]][ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="flow_cov"]),
  paste(round(ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="flow_cov"],digits=2),ss1$coefficients[[9]][ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="flow_cov"]),
  paste(round(ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="div.hp"],digits=2),ss1$coefficients[[9]][ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="div.hp"]),
  paste(round(ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="div.hp"],digits=2),ss1$coefficients[[9]][ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="div.hp"]),
  paste(round(ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="flow_cov" & ss1$coefficients$Response=="spec.no"],digits=2),ss1$coefficients[[9]][ss1$coefficients$Predictor=="flow_cov" & ss1$coefficients$Response=="spec.no"]),
  paste(round(ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="div.hp" & ss1$coefficients$Response=="spec.no"],digits=2),ss1$coefficients[[9]][ss1$coefficients$Predictor=="div.hp" & ss1$coefficients$Response=="spec.no"]),
  paste(round(ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="spec.no"],digits=2),ss1$coefficients[[9]][ss1$coefficients$Predictor=="temps" & ss1$coefficients$Response=="spec.no"]),
  paste(round(ss1$coefficients$Std.Estimate[ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="spec.no"],digits=2),ss1$coefficients[[9]][ss1$coefficients$Predictor=="man.bin" & ss1$coefficients$Response=="spec.no"])
)

# Basis model (all arrows)
b=matrix(c(rep(0,5*5)),5,5,byrow=T)
colnames(b)<-c("flower cover","host plant spec. no.","butterfly spec. no.","summer temperature","management")
rownames(b)<-colnames(b)
b[5,1]=0.1
b[4,1]=0.1
b[5,2]=0.1
b[4,2]=0.1
b[2,3]=0.1
b[1,3]=0.1
b[5,3]=0.1
b[4,3]=0.1


### DELTA

# manual matrix with estimates from psem

d=matrix(c(rep(0,4*4)),4,4,byrow=T)
colnames(d)<-c("delta flower cover","delta host plant spec. no.","delta butterfly spec. no.","delta summer temperature")
rownames(d)<-colnames(d)
d[1,3]=dm1$coefficients$Std.Estimate[dm1$coefficients$Predictor=="flow_cov" & dm1$coefficients$Response=="delta"]
d[4,3]=dm1$coefficients$Std.Estimate[dm1$coefficients$Predictor=="temps" & dm1$coefficients$Response=="delta"]


dsignlabels<-c( # significance values from summary for single arrows in model, order according to number of response var
  paste(round(dm1$coefficients$Std.Estimate[dm1$coefficients$Predictor=="flow_cov" & dm1$coefficients$Response=="delta"],digits=2),dm1$coefficients[[9]][dm1$coefficients$Predictor=="flow_cov" & dm1$coefficients$Response=="delta"]),
  paste(round(dm1$coefficients$Std.Estimate[dm1$coefficients$Predictor=="temps" & dm1$coefficients$Response=="delta"],digits=2),dm1$coefficients[[9]][dm1$coefficients$Predictor=="temps" & dm1$coefficients$Response=="delta"])
)

# Basis model (all arrows)
bd=matrix(c(rep(0,4*4)),4,4,byrow=T)
colnames(bd)<-c("delta flower cover","delta host plant spec. no.","delta butterfly spec. no.","delta summer temperature")
rownames(bd)<-colnames(bd)
bd[4,1]=0.1
bd[4,2]=0.1
bd[2,3]=0.1
bd[1,3]=0.1
bd[4,3]=0.1


### PLOTTING

# Basis model s66
png(here::here("figures","sem1.png"), res=600, height=8, width=8, units = "cm")

qgraph(b,shape="square",layout=l1,labels = F, vsize=18,labels=F, edge.color="black", edge.label.cex=1.8, asize=6, images=c(here::here("figures","Logo_Gentiana_verna.png"),here::here("figures","Logo_host_plant.png"),here::here("figures","Logo_Erebia_euryale.png"),here::here("figures","Logo_temperature.png"),here::here("figures","Logo_management.png")), borders=F) ;text(-1.1,1.1,"a)",cex=1.3);abline(-1.3,0, lwd=2, col="slategray4")

dev.off()

# path model s66
png(here::here("figures","sem2.png"), res=600, height=8, width=8, units = "cm")

qgraph(t,shape="square", layout=l1, labels=F, vsize=18, edge.color=c("slategray2","black","slategray2","black", "slategray2","black","black","slategray2"), colFactor=0, asize=6, edge.labels=signlabels, edge.label.bg=T, edge.label.cex=1.8, edge.label.margin=0.025, lty=c(1,1,2,1,1,1,1,1), images=c(here::here("figures","Logo_Gentiana_verna.png"),here::here("figures","Logo_host_plant.png"),here::here("figures","Logo_Erebia_euryale.png"),here::here("figures","Logo_temperature.png"),here::here("figures","Logo_management.png")), borders = F
       );text(-1,0.25,paste("R²=",ss1$R2$Conditional[ss1$R2$Response=="flow_cov"]),cex=.8
        );text(0.3,0.25,paste("R²=",ss1$R2$Conditional[ss1$R2$Response=="spec.no"]),cex=.8
        );text(1,0.25,paste("R²=",ss1$R2$Conditional[ss1$R2$Response=="div.hp"]),cex=.8
        );text(-1.1,1.1,"b)",cex=1.3
        );abline(-1.3,0, lwd=2, col="slategray4"
        );text(0.45,1.1,paste("Fisher's C =", ss1$Cstat$Fisher.C, "\np-value = ", ss1$Cstat$P.Value), adj=0, cex=.7)

dev.off()

# Basis model delta
png(here::here("figures","sem3.png"), res=600, height=8, width=8, units = "cm")

qgraph(bd,shape="square",layout=l1,labels=F, vsize=18,labels=F, edge.color="black", edge.label.cex=1.8,asize=6, images=c(here::here("figures","Logo_Gentiana_verna.png"),here::here("figures","Logo_host_plant.png"),here::here("figures","Logo_Erebia_euryale.png"),here::here("figures","Logo_temperature.png")), borders=F);text(-1.1,1.1,"c)",cex=1.3); text(
  -0.3,1, expression(phantom("19-") * "09"), col="dodgerblue", cex=.8); text(
  -0.3,1, expression("19" * phantom("-09")), col="orange", cex=.8); text(
  -0.3,1, expression(phantom("19") * "-" * phantom("09")), cex=.8); text(
  -1,-1.23, expression(phantom("19-") * "09"), col="dodgerblue", cex=.8); text(
  -1,-1.23, expression("19" * phantom("-09")), col="orange", cex=.8); text(
  -1,-1.23, expression(phantom("19") * "-" * phantom("09")), cex=.8); text(
  0,-1.23, expression(phantom("19-") * "09"), col="dodgerblue", cex=.8); text(
  0,-1.23, expression("19" * phantom("-09")), col="orange", cex=.8); text(
  0,-1.23, expression(phantom("19") * "-" * phantom("09")), cex=.8); text(
  1,-1.23, expression(phantom("19-") * "09"), col="dodgerblue", cex=.8); text(
  1,-1.23, expression("19" * phantom("-09")), col="orange", cex=.8); text(
  1,-1.23, expression(phantom("19") * "-" * phantom("09")), cex=.8)

dev.off()

# path model delta
png(here::here("figures","sem4.png"), res=600, height=8, width=8, units = "cm")

qgraph(d,shape="square",layout=l1,vsize=18, labels=F, edge.color=c("slategray3","black"),colFactor=0,asize=6,edge.labels=dsignlabels,edge.label.bg=T, edge.label.cex=1.8, edge.label.margin=0.025, images=c(here::here("figures","Logo_Gentiana_verna.png"),here::here("figures","Logo_host_plant.png"),here::here("figures","Logo_Erebia_euryale.png"),here::here("figures","Logo_temperature.png")), borders=F
      );text(0.3,-0.7,paste("R²=",dm1$R2$R.squared),cex=.8
      );text(-1.1,1.1,"d)",cex=1.3
      );text(0.45,1.1,paste("Fisher's C =", dm1$Cstat$Fisher.C, "\np-value = ", dm1$Cstat$P.Value), adj=0, cex=.7); text(
  -0.3,1, expression(phantom("19-") * "09"), col="dodgerblue", cex=.8); text(
  -0.3,1, expression("19" * phantom("-09")), col="orange", cex=.8); text(
  -0.3,1, expression(phantom("19") * "-" * phantom("09")), cex=.8); text(
  -1,-1.23, expression(phantom("19-") * "09"), col="dodgerblue", cex=.8); text(
  -1,-1.23, expression("19" * phantom("-09")), col="orange", cex=.8); text(
  -1,-1.23, expression(phantom("19") * "-" * phantom("09")), cex=.8); text(
  0,-1.23, expression(phantom("19-") * "09"), col="dodgerblue", cex=.8); text(
  0,-1.23, expression("19" * phantom("-09")), col="orange", cex=.8); text(
  0,-1.23, expression(phantom("19") * "-" * phantom("09")), cex=.8); text(
  1,-1.23, expression(phantom("19-") * "09"), col="dodgerblue", cex=.8); text(
  1,-1.23, expression("19" * phantom("-09")), col="orange", cex=.8); text(
  1,-1.23, expression(phantom("19") * "-" * phantom("09")), cex=.8)

dev.off()

path1<-readPNG(here::here("figures","sem1.png"))
path2<-readPNG(here::here("figures","sem2.png"))
path3<-readPNG(here::here("figures","sem3.png"))
path4<-readPNG(here::here("figures","sem4.png"))
```

```{r semplot, fig.cap="", echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, fig.width=11, fig.height=11}
grid.arrange(rasterGrob(path1), rasterGrob(path2), rasterGrob(path3), rasterGrob(path4), nrow=2)
```

\clearpage

\newpage

**Figure 4:**

```{r commsc, fig.cap="", fig.width=6, fig.height=5, echo=FALSE}

ggplot(modC,aes(x=elev, y=comsc, colour=year, fill=year)) +
  geom_ribbon(aes(ymin = CI_lower, ymax = CI_upper), alpha = 0.2, colour = NA) + # colour=NA to remove outer lines
  geom_line(size=2)+
  geom_point(data=pdl,aes(x=elev, y=comsc),size=3,alpha=.4,shape=16) +
  theme_classic()+ # white background
  theme(# panel.background = element_rect(colour = "black", size=0.5), # black frame
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    legend.position = c(0.1,0.8),
    legend.title=element_blank(), # remove legend label
    legend.text = element_text(size=14),
    legend.background = element_blank(),
    axis.text = element_text(size=14),
    axis.title.x = element_text(size=14,margin = margin(t = 10, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(size=14,margin = margin(t = 0, r = 10, b = 0, l = 0)))+
  labs(x="elevation [m.a.s.l.]",y="community elevation score")+
  scale_x_continuous(breaks=c(800,1200,1600,2000))+
  scale_y_continuous(n.breaks=6)+
  scale_fill_manual(name="year", values = c("2009"="dodgerblue", "2019"="orange"))+
  scale_color_manual(name="year", values = c("2009"="dodgerblue", "2019"="orange"))+
annotation_custom(
    grid::rasterGrob(
      image = readPNG(here::here("figures","Logo_Erebia_euryale.png")),
      x = .1, y =.93,
      width =.15))
```

\clearpage

\newpage

**Figure 5:**

```{r buttshift, include=FALSE}

z<-read.csv(here::here("data","butterfly-shifts-Tukey-results-figure.csv"), sep=";") # read species shifts with significance symbols
colnames(z)[1]<-"genus_species"

txtcol<-revalue(z$signcol[order(z$mean)], c(ns="grey60",signif="black", alpns="lightslateblue", alpsignif="turquoise4")) # color y axis labels, sorted according to mean

buttshifts<-ggplot(z, aes(mean,reorder(genus_species,mean),col=signcol)) + # reorder: adjust order of species on y axis
  geom_vline(xintercept = 0,linetype="dashed") +
  geom_pointrange(aes(xmin=left95,xmax=right95),shape="|",size=.7,stroke=1) +
  theme(
    panel.background = element_rect(fill = NA), # background plot white
    legend.position = "top",
    legend.title=element_text(size=9),
    legend.text = element_text(size=9),
    legend.key.height = unit(0.5, "cm"),
    legend.background = element_blank(),
    axis.line = element_line(size = 0.5),
    axis.ticks.y = element_blank(), # remove axis ticks
    axis.text.y = element_text(face = "italic", colour=txtcol),
    axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
    axis.title.y = element_blank()
  ) +
  scale_colour_manual(name="signif.  n.s.", values=c(alpsignif="turquoise4", signif="black", alpns="lightslateblue", ns="grey60"),labels=c("alpine (> 500 m)","non-alpine"," "," "),
  guide=guide_legend(ncol=2, label.position = "left", label.hjust = 0, title.position = "top", title.hjust = 1)) +
  geom_text(aes(x=signpos,label = signlvl), vjust=0.8, hjust=0, show.legend = F) +
  labs(x="Elevational shift [m]",y="Species") +
  scale_x_continuous(breaks=c(-300, -200, -100, 0, 100, 200, 300)) +
  coord_cartesian(xlim = c(-330, 318)) +
  annotation_custom(
    grid::rasterGrob(
      image = readPNG(here::here("figures","Logo_Erebia_euryale.png")),
      x = .8, y =.04,
      width =.35))
```

```{r plantshift, include=FALSE}

s<-read.csv(here::here("data","hostplant-shifts-Tukey-results-figure.csv"), sep=";") # read species shifts with significance symbols
colnames(s)[1]<-"abbr"

plantshifts<-ggplot(s, aes(mean,reorder(abbr,mean),col=signcol)) + # reorder: adjust order of species on y axis
  geom_vline(xintercept = 0,linetype="dashed") + # zero line
  geom_pointrange(aes(xmin=left95,xmax=right95),shape="|",size=0.5,stroke=1) + # draw ranges
  theme(
    panel.background = element_rect(fill = NA), # background white
    axis.line = element_line(size = 0.5),
    axis.ticks.y = element_blank(), # remove axis ticks
    axis.text.y = element_text(face = "italic"),
    legend.position = "none",
    axis.title.x = element_text(margin = margin(t = 10, r = 0, b = 0, l = 0)),
    axis.title.y = element_blank()
  ) +
  scale_colour_manual(values=c(ns="grey60",signif="black")) +
  geom_text(aes(x=signpos,label = signlvl), vjust=0.8,hjust=0) + 
  labs(x="Elevational shift [m]",y="Species") +
  scale_y_discrete(labels=s$taxon[order(s$mean)]) +
  coord_cartesian(xlim = c(-250,248)) +
  annotation_custom(
    grid::rasterGrob(
      image = readPNG(here::here("figures","Logo_host_plant.png")),
      x = .8, y =.035,
      width =.4))
```

```{r shifts, fig.cap="", fig.width=8.5, fig.height=11, warning=FALSE, echo=FALSE}
library(patchwork)
((buttshifts + plot_spacer()) + inset_element(plantshifts, 0,0,1,1, align_to = "full")) + plot_layout(widths = c(1,1.7)) # plot_spacer() & inset_element to stretch plant shifts over whole length of plot
```

# Supplementary Material {.unnumbered}

**Figure S1:**

```{r climatemodelling, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=3, fig.cap="Predicted temperature data for 4 selected study sites in comparison to measured temperature data of one exemplary climate station over the course of one year (here: 2019). Predicted temperatures are presented in transparent colors (red: 818 m a.s.l., orange: 1106 m a.s.l., green: 1580 m a.s.l., blue: H7 1986 m a.s.l.). Black circles represent measured temperature data of one climate station located 834 m asl. For the prediction of site temperature data, we used the temperature measurements of up to 16 climate stations (see Figure 1c main text; data not plotted here). At all climate stations, temperature was recorded every 10 min; but mean daily temperatures were used for the prediction with generalized additive models, that included elevation, day lengths (as a surrogate for season) and date as explaining variables.", dpi=300}
include_graphics("J:/Auswertung/Manuscript_I/Abbildungen/Paper_I/climate_stations_temperature.jpeg") # was created externally
```

\clearpage

\newpage

**Figure S2:**

```{r potshift, echo=FALSE, warning=FALSE, message=FALSE, fig.width=8, fig.height=3, fig.cap="MAT (left) and MST (right) of all study sites averaged over the last decade from 2009 (blue) to 2019 (orange). The gradual temperature increase equals the slope of these linear models (MAT / MST ~ elevation, black lines).", dpi=300}

summean$time<-"MST"; yearmean$time<-"MAT"
mt<-bind_rows(summean[summean$year >="2009" & summean$year <="2019",], yearmean[yearmean$year >="2009" & yearmean$year <="2019",])

transblack<-adjustcolor("black",alpha.f = 0.3)

# Difference day means 2009 - 2019 for summer / whole year

ggplot(mt, aes(year, daymeanT))+
  facet_wrap(~time, scales="free_y")+
  geom_point(pch=16, cex=3, col=rep(c("dodgerblue",rep(transblack,9),"orange"),2))+
  geom_smooth(method=lm, se=F, col="black")+
  theme_classic()+
  labs(y="temperature [°C]")+
  scale_x_continuous(breaks=seq(2009,2019,by=2), )+
  theme(
    plot.margin = unit(c(.3, .5, .3, .3),"cm"),
    axis.text = element_text(size=12),
    axis.title.x = element_text(size=12, margin = margin(t = 10, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
    strip.background = element_blank(), # background facet_labels
    strip.text = element_text(size=14) # text facet_labels
  )+
  geom_text(x=2016.3, y=4.85, hjust=0, col="black",
            label=paste("R² =", round(tmean[["r.squared"]], digits=2),"\nslope =", round(tmean[["coefficients"]][2],digits=3)))+
  geom_text(x=2016.3, y=11.1, hjust=0, col="black",
            label=paste("R² =", round(stmean[["r.squared"]], digits=2),"\nslope =", round(stmean[["coefficients"]][2],digits=3)))
```

\clearpage

\newpage

**Figure S3:**

```{r temp100, eval=FALSE, fig.width=6, fig.height=3, fig.cap="Mean temperature along the elevational gradient based on real data from nearby climate stations. Left: The mean daily temperature from 2009 to 2019 was averaged per station (grey points). The temperature difference per 100 m in elevation equals the slope of this linear model (mean temperature ~ elevation, black line). Colored lines show the average per climate station of the two sampled years 2009 (blue) and 2019 (orange). Right: Colored lines from the left graph representing the two sampled years each with the underlying data points.", dpi=300}
# temperature difference per 100 m in elevation 2009-2019
# raw climate station data (LT) not publicly available
elevmean<-aggregate(daymeanT~Elev_50m, data=LT, FUN=mean)
# single years 2009 & 2019
elevmean09<-aggregate(daymeanT~Elev_50m, data=LT[LT$year.x==2009,], FUN=mean)
elevmean19<-aggregate(daymeanT~Elev_50m, data=LT[LT$year.x==2019,], FUN=mean)

transblue<-adjustcolor("dodgerblue",alpha.f = 0.5)
transorange<-adjustcolor("orange",alpha.f = 0.5)

# main plot with average and single year lines
main<-bind_rows("mean"=elevmean,"2009"=elevmean09,"2019"=elevmean19, .id = "year") %>%
ggplot(aes(Elev_50m, daymeanT, col=year)) +
  geom_smooth(method=lm, se=F) +
  geom_point(aes(Elev_50m, daymeanT),data=elevmean,col="black", pch=16, cex=2, alpha=.3) +
  theme_classic() +
  scale_color_manual(
    values = c("mean"="black", "2009"=transblue,"2019"=transorange),
    name="year",
    labels = c("mean"="2009 - 2019","2009"="2009", "2019"="2019")) +
  theme(
    plot.margin = unit(c(.5, .3, .3, .3),"cm"),
    legend.position = "none",
    axis.text = element_text(size=12),
    axis.title.x = element_text(size=12, margin = margin(t = 10, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0))) +
  labs(x="elevation [m.a.s.l.]", y="mean temperature [°C]") +
  geom_text(x=-Inf, y=-Inf, hjust=-0.1, vjust=-1, col="black",
            label=paste("slope =", round(tc100[["coefficients"]][["fixed"]][["Elev_50m"]], 4)))

# side plots single years
yeartags<-data.frame(x=c(rep(2500,2)), y=c(rep(9.75,2)),lab=c("2009","2019"),
                 year=c("2009","2019"))

singleyears<-bind_rows("2009"=elevmean09,"2019"=elevmean19, .id = "year") %>%
ggplot(aes(Elev_50m, daymeanT, col=year)) +
  facet_wrap(vars(fct_inorder(year)),nrow = 2) +
  geom_smooth(method=lm, se=F) +
  geom_point(pch=16, cex=2, alpha=.3) +
  theme_classic() +
  scale_color_manual(
    values = c("2009"="dodgerblue","2019"="orange"),
    name="year",
    labels = c("2009"="2009", "2019"="2019")) +
  theme(
    plot.margin = unit(c(.5, .3, .3, .3),"cm"),
    legend.position = "none",
    axis.title.x = element_text(size=12, margin = margin(t = 10, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(size=12, margin = margin(t = 0, r = 10, b = 0, l = 0)),
    strip.text = element_blank()) + # remove Label bar above plots from facetwrap
  labs(x="elevation [m.a.s.l.]", y="mean temperature [°C]") +
  annotate(geom = 'segment', y = -Inf, yend = -Inf, color = 'black', x = -Inf, xend = Inf, size = 0.5) +
  geom_text(inherit.aes = FALSE, data=yeartags, aes(x= Inf, y=Inf, label=lab),hjust="right", vjust="top",size=5)

library(patchwork)
main + singleyears + plot_layout(widths = c(2,1))
```

\clearpage

\newpage

**Figure S4:**

```{r shiftselectbutt, echo=FALSE, warning=FALSE, fig.cap="Change in mean elevational shift and number of included butterfly species (y-axes) depending on the chosen minimum number of individuals per species (x-axis). Results are shown for all included species (black) and for significantly shifting (p &le; 0.05) species with their respective mean shift (dashed lines).", fig.width=7, fig.height=5, dpi=300}

par(mfrow=c(2,1),mar=c(1,6,2,2))

# Elev shift
plot(mean~no.ind, data=a, ylim=c(min(mean),max(meansig)), xlab=NA, ylab="average elevational\nshift [m]", xaxt = "n", pch=19)
abline(mean(a$mean),0, lty=2)
par(new=T)
plot(meansig~no.ind, data=a, ylim=c(min(mean), max(meansig)), xaxt = "n", yaxt="n",xlab=NA, ylab=NA, col="darkorange2", pch=19)
abline(mean(a$meansig), 0, col="darkorange2", lty=2)

# line labels
text(x=31, y=c(mean(a$mean)-6, mean(a$meansig)-6), pos=2, labels=c(paste(round(mean(a$mean),digits = 0),"m"), paste(round(mean(a$meansig), digits=0),"m")), col=c("black","darkorange2"))

par(mar=c(5,6,0,2))

# No. included species
plot(no.species~no.ind,data=a, ylim=c(min(s+ss+sss),max(no.species)), yaxp = c(10, 40, 3), xlab="minimum no. of individuals per species", ylab="no. of included\nspecies", pch=19)
par(new=T)
plot(s+ss+sss~no.ind,data=a,ylim=c(min(s+ss+sss),max(no.species)), xaxt="n",yaxt="n",xlab=NA,ylab=NA,col="darkorange2", pch=19
     ); grid.raster(readPNG(here::here("figures","Logo_Erebia_euryale.png")), # insert logo
            x = .08, y =.1,
            width =.1)

# Legend
legend("topright", inset=c(0,-0.05),legend= c("all species","signif. shifting"), pch=19, col = c("black", "darkorange2"), bty = "n", y.intersp=1.3)

par(mfrow=c(1,1))
```

\clearpage

\newpage

**Figure S5:**

```{r shiftselecthp, echo=FALSE, warning=FALSE, fig.cap="Change in mean elevational shift and number of included host plant species (y-axes) depending on the chosen minimum number of occupied subplots per species (x-axis). Results are shown for all included species (black) and for significantly shifting (p &le; 0.05) species with their respective mean shift (dashed lines).", fig.width=7, fig.height=5.5, dpi=300}

par(mfrow=c(2,1),mar=c(1,6,2,2)) # broad plot margins

# Elev shift
plot(mean~no.sb, data=m, ylim=c(min(meansig),max(meansig)),xlab = NA, xaxt="n", ylab="average elevational\nshift [m]", yaxp = c(- 40, 80, 3), pch=19)
abline(mean(m$mean), 0, lty=2)
par(new=T)
plot(meansig~no.sb, data=m, ylim=c(min(meansig),max(meansig)),xlab = NA, xaxt = "n", ylab = NA, yaxt = "n",col="darkorange2", pch=19)
abline(mean(m$meansig), 0, col="darkorange2", lty=2)

# line labels
text(x=31, y=c(mean(m$mean)-7, mean(m$meansig)-7), pos=2, labels=c(paste(round(mean(m$mean),digits = 0),"m"), paste(round(mean(m$meansig), digits=0),"m")), col=c("black","darkorange2"))

par(mar=c(5,6,0,2))

# No. included species
plot(no.species~no.sb,data=m,ylim=c(min(s+ss+sss),max(m$no.species)),xlab="minimum no. of occupied subplots",ylab="no. of included\nspecies", pch=19)
par(new=T)
plot(s+ss+sss~no.sb,data=m,ylim=c(min(s+ss+sss),max(m$no.species)),xlab = NA, xaxt="n", ylab = NA, yaxt = "n",col="darkorange2", pch=19
     ); grid.raster(readPNG(here::here("figures","Logo_host_plant.png")), # insert logo
            x = .08, y =.08,
            width =.1)

# Legend
legend("topright",inset=c(0,-0.05),legend= c("all species","signif. shifting"), pch=19,col = c("black", "darkorange2"),bty = "n", y.intersp=1.3)

par(mfrow=c(1,1))
```

\clearpage

\newpage

**Figure S6:**

```{r alpshift, echo=FALSE, warning=FALSE, message=FALSE, fig.cap="Abundance-weighted mean elevational shift per species against mean elevation of occurrence in 2009. Shifting distances decreased significantly (p &le; 0.05) with increasing elevation while in contrast, mountainous species (lower elevational limit ≥ 500 m.a.s.l. according to Paolucci (2013), blue) shifted 140 ± 57 m more than other species (linear model, DF = 34, p &le; 0.05).", dpi=300}

ggplot(aes(melev, estimate, color=alpine), data=alpi) +
  geom_hline(yintercept = 0, linetype="dashed") +
  geom_point(size=3, shape=16) +
  geom_smooth(method=lm, mapping=aes(y=predict(modalpi, alpi)), se = F) +
  theme_classic() +
  theme(
    legend.title = element_blank(),
    legend.position = c(0.85, 0.93),
    legend.key = element_blank(), # remove grey background behind legend points
    legend.text = element_text(size=11),
    axis.text = element_text(size=11)
  ) +
  labs(x="abundance-weighted mean elevation [m.a.s.l.]",y="mean elevational shift") +
  scale_color_manual(values = c("alpine"="turquoise4", "non-alpine"="black")) +
  geom_text(x=Inf, y=-Inf, hjust=1, vjust=-0.8, col="black",
            label=paste0("R² = ", round(valalpi$r.squared,2)))
```
